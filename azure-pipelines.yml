trigger:
  - staging
  - trying
  - master
variables:
    BAZEL_BUILD_CACHE: $(Pipeline.Workspace)/__bazel_build_cache
jobs:
  - template: ci/azure-pipelines/jobs/bazel-build-clients.yml
  - template: ci/azure-pipelines/jobs/bazel-build-serving-openvino.yml
  - template: ci/azure-pipelines/jobs/bazel-build-serving-tensorflow-cpu.yml
  - template: ci/azure-pipelines/jobs/bazel-build-serving-tensorflow-gpu.yml
  - template: ci/azure-pipelines/jobs/bazel-build-serving-tensorflow-lite-cpu.yml
  - template: ci/azure-pipelines/jobs/bazel-build-serving-tensorrt.yml
  - template: ci/azure-pipelines/jobs/buildifier.yml
  - template: ci/azure-pipelines/jobs/clang-format.yml
  - template: ci/azure-pipelines/jobs/commit-message.yml
  - template: ci/azure-pipelines/jobs/copyright.yml
  - template: ci/azure-pipelines/jobs/flake8.yml
  - template: ci/azure-pipelines/jobs/tox-model-compiler.yml
  - job: BazelBuildServingML
    displayName: Bazel build serving (ML)
    strategy:
        matrix:
            Linux:
              vmImage: ubuntu-latest
            macOS:
              vmImage: macos-latest
    pool:
        vmImage: $(vmImage)
    timeoutInMinutes: 0
    steps:
      - template: ci/azure-pipelines/install-bazel.yml
      - task: UsePythonVersion@0
        displayName: Use latest Python
      - template: ci/azure-pipelines/use-build-cache.yml
        parameters:
            key: bazel-build-serving-ml
            path: $(BAZEL_BUILD_CACHE)
      - script: |
            ci/checks/bazel-build-serving.py \
                --config=ml \
                -c opt \
                --disk_cache="$BAZEL_BUILD_CACHE" \
                --incompatible_no_support_tools_in_action_inputs=false \
                --incompatible_disable_nocopts=false
        displayName: Bazel build serving
      - task: PublishBuildArtifacts@1
        displayName: Publish build artifacts
        inputs:
            pathtoPublish: __adlik_serving/adlik_serving
            artifactName: adlik-serving-ml
